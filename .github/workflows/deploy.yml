name: Java CI/CD with Aliyun ACR

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  # 组合镜像全名: 注册中心/命名空间/仓库名
  # 注意：这里直接引用 Secrets，确保你在 GitHub 后台配好了 ALIYUN_NAMESPACE = dsf_project
  IMAGE_NAME: ${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAMESPACE }}/message_push

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Run Tests
        run: ./mvnw test

      # 登录阿里云 ACR
      - name: Log in to Aliyun ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      # 构建并推送镜像
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # 打两个标签: latest (用于生产) 和 commit_sha (用于回滚/追溯)
          tags: ${{ env.IMAGE_NAME }}:latest,${{ env.IMAGE_NAME }}:${{ github.sha }}

  deploy:
    needs: build-and-publish
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            # 1. 登录阿里云 (防止私有镜像拉取失败)
            echo "${{ secrets.ALIYUN_PASSWORD }}" | docker login ${{ secrets.ALIYUN_REGISTRY }} --username ${{ secrets.ALIYUN_USERNAME }} --password-stdin
            
            # 2. 停止并移除旧容器 (如果存在)
            docker stop message-push-container || true
            docker rm message-push-container || true
            
            # 3. 拉取刚才构建的最新镜像
            # 这里的变量无法直接传导到 ssh script 内部，所以我们用明确的拼接方式，或者重新定义变量
            # 为稳妥起见，直接使用完整的镜像名进行拉取
            docker pull ${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAMESPACE }}/message_push:latest
            
            # 4. 启动新容器
            docker run -d \
              -p 8080:8080 \
              --name message-push-container \
              --restart always \
              ${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAMESPACE }}/message_push:latest