name: Java CI/CD with Aliyun ACR

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  # 镜像全名
  IMAGE_NAME: ${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAMESPACE }}/message_push

jobs:
  # 任务1: 构建并发布 (这里做了性能优化)
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 优化点: 使用 GitHub 缓存 Maven 依赖，下一次构建不需要重新下载 jar 包
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      # 优化点: 在 Runner 上直接编译，比在 Docker 里快
      - name: Build with Maven
        run: ./mvnw clean package -DskipTests

      - name: Log in to Aliyun ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.IMAGE_NAME }}:latest,${{ env.IMAGE_NAME }}:${{ github.sha }}

  # 任务2: 部署 (这里保留了你的 SSH Key 配置)
  deploy:
    needs: build-and-publish
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            # 1. 登录阿里云 (防止拉取权限报错)
            echo "${{ secrets.ALIYUN_PASSWORD }}" | docker login ${{ secrets.ALIYUN_REGISTRY }} --username ${{ secrets.ALIYUN_USERNAME }} --password-stdin
            
            # 2. 停止旧容器
            docker stop message-push-container || true
            docker rm message-push-container || true
            
            # 3. 拉取新镜像 (因为体积小了，这里也会变快)
            docker pull ${{ env.IMAGE_NAME }}:latest
            
            # 4. 启动新容器
            docker run -d \
              -p 9001:9001 \
              --name message-push-container \
              --restart always \
              ${{ env.IMAGE_NAME }}:latest